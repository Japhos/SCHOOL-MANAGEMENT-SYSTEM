<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Finance Management - NYAMBUNWA ACADEMY</title>
<style>
body{font-family:'Segoe UI',Tahoma,sans-serif;margin:0;background:#e9f7ec;}
header{background:#0b722d;color:#fff;padding:18px;text-align:center;font-size:26px;font-weight:700;}
.sub-title{text-align:center;color:#064d1a;font-weight:600;margin-top:6px;}
.container{padding:20px;max-width:1100px;margin:0 auto;}
.section{background:#fff;padding:22px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.12);margin-top:20px;border-left:6px solid #0b722d;}
h3{color:#064d1a;margin-top:0;}
h4{color:#064d1a;margin-top:15px;}
label{display:block;margin-top:10px;font-weight:600;color:#064d1a;}
select,input{width:100%;padding:8px;margin-top:4px;border-radius:5px;border:1px solid #aaa;}
.btn{margin-top:10px;padding:8px 14px;border:none;border-radius:6px;background:#0b722d;color:#fff;cursor:pointer;}
.btn.danger{background:#b30000;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{border:1px solid #ccc;padding:8px;font-size:14px;}
th{background:#d6f5d9;}
footer{margin-top:40px;text-align:center;padding:12px;background:#0b722d;color:#fff;}
@media print{
 body *{visibility:hidden;}
 .printArea,.printArea *{visibility:visible;}
 .printArea{position:absolute;top:0;left:0;width:100%;}
}
</style>
</head>
<body>

<header>FINANCE MANAGEMENT</header>
<div class="sub-title">NYAMBUNWA ACADEMY</div>

<div class="container">

<!-- ADMIN FEE SETUP -->
<div class="section" id="adminFeeSection" style="display:none;">
<h3>Admin: Set Total Fee for Term</h3>

<label>Select Class (optional, leave blank for all)</label>
<select id="feeClassSelect">
<option value="">All Classes</option>
</select>

<label>Select Term</label>
<select id="feeTermSelect">
<option value="">Select Term</option>
<option value="Term 1">Term 1</option>
<option value="Term 2">Term 2</option>
<option value="Term 3">Term 3</option>
</select>

<label>Total Fee</label>
<input type="number" id="totalFeeInput" placeholder="Enter total fee">

<button class="btn" onclick="saveTotalFee()">Save Total Fee</button>

<h4>Current Fee Settings</h4>
<table id="feeTable">
<thead>
<tr>
<th>Term</th>
<th>Class</th>
<th>Total Fee</th>
</tr>
</thead>
<tbody>
<tr><td colspan="3">No fee set yet</td></tr>
</tbody>
</table>
</div>

<!-- PAYMENT ENTRY -->
<div class="section">
<h3>Record Fee Payment</h3>

<label>Select Class</label>
<select id="classSelect" onchange="loadStudentsByClass()">
<option value="">Select Class</option>
</select>

<label>Select Student</label>
<select id="studentSelect" onchange="loadStudentHistory()">
<option value="">Select Student</option>
</select>

<label>Term</label>
<select id="termSelect">
<option value="">Select Term</option>
<option value="Term 1">Term 1</option>
<option value="Term 2">Term 2</option>
<option value="Term 3">Term 3</option>
</select>

<label>Amount Paid</label>
<input type="number" id="amountPaid">

<label>Payment Date</label>
<input type="date" id="paymentDate" readonly>

<button class="btn" onclick="savePayment()">Save Payment</button>
</div>

<!-- PAYMENT HISTORY -->
<div class="section">
<h3>Payment History (Selected Student)</h3>

<table>
<thead>
<tr>
<th>Date</th>
<th>Term</th>
<th>Amount</th>
<th>Balance</th>
<th id="adminCol">Action</th>
</tr>
</thead>
<tbody id="historyTable">
<tr><td colspan="5">Select a student to view history</td></tr>
</tbody>
</table>

<button class="btn" onclick="printHistory()">ðŸ–¨ Print History</button>
</div>

<!-- PAYMENTS & BALANCES -->
<div class="section">
<h3>Payments & Balances</h3>
<table>
<thead>
<tr>
<th>Student</th>
<th>Class</th>
<th>Total Fee</th>
<th>Total Paid</th>
<th>Balance</th>
</tr>
</thead>
<tbody id="financeTable"></tbody>
</table>

<button class="btn" onclick="goBack()">â¬… Back to Main Menu</button>
</div>

</div>

<footer>Â© 2025 NYAMBUNWA ACADEMY â€” School Management System</footer>

<!-- PRINTABLE HISTORY -->
<div id="historyPrint" class="printArea" style="display:none;padding:20px;">
<h2 style="text-align:center;color:#0b722d;">NYAMBUNWA ACADEMY</h2>
<h3 style="text-align:center;">Fee Payment History</h3>
<p id="historyStudent"></p>

<table>
<thead>
<tr>
<th>Date</th>
<th>Term</th>
<th>Amount</th>
<th>Balance</th>
</tr>
</thead>
<tbody id="historyPrintTable"></tbody>
</table>

<p style="margin-top:30px;">
<strong>Authorized Signature:</strong> ______________________
</p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig={
 apiKey:"AIzaSyBZWRqW1a0qLyx76QZapberiE4Mio97OqI",
 authDomain:"school-management-system-24753.firebaseapp.com",
 projectId:"school-management-system-24753",
 storageBucket:"school-management-system-24753.firebasestorage.app",
 messagingSenderId:"98011038194",
 appId:"1:98011038194:web:b54b1b91e543127347ab6b"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const role=localStorage.getItem("userRole");

const classSelect=document.getElementById("classSelect");
const studentSelect=document.getElementById("studentSelect");
const paymentDate=document.getElementById("paymentDate");
const amountPaid=document.getElementById("amountPaid");
const termSelect=document.getElementById("termSelect");
const historyTable=document.getElementById("historyTable");
const financeTable=document.getElementById("financeTable");
const historyStudent=document.getElementById("historyStudent");
const historyPrintTable=document.getElementById("historyPrintTable");
const feeTable=document.getElementById("feeTable").querySelector("tbody");

// ADMIN FEE SETUP ELEMENTS
const feeClassSelect=document.getElementById("feeClassSelect");
const feeTermSelect=document.getElementById("feeTermSelect");
const totalFeeInput=document.getElementById("totalFeeInput");

// INIT
window.onload=()=>{
 if(!localStorage.getItem("loggedInUser")) location="login.html";
 paymentDate.value=new Date().toISOString().split("T")[0];
 if(role==="admin") document.getElementById("adminFeeSection").style.display="block";
 else document.getElementById("adminCol").style.display="none";
 loadClasses(); loadClassesForFee(); loadFinance(); loadFeeSettings();
};

// LOAD CLASSES
function loadClasses(){
 let c=new Set();
 db.ref("students").once("value",s=>{
  s.forEach(x=>c.add(x.val().class));
  c.forEach(v=>classSelect.innerHTML+=`<option>${v}</option>`);
 });
}

// LOAD STUDENTS BY CLASS
function loadStudentsByClass(){
 studentSelect.innerHTML="<option value=''>Select Student</option>";
 historyTable.innerHTML="<tr><td colspan='5'>Select a student</td></tr>";
 if(!classSelect.value) return;
 db.ref("students").orderByChild("class").equalTo(classSelect.value)
 .once("value",s=>{
  s.forEach(x=>{
   studentSelect.innerHTML+=`<option value="${x.key}|${x.val().name}|${x.val().class}">${x.val().name}</option>`;
  });
 });
}

// ADMIN FEE SETUP FUNCTIONS
function loadClassesForFee(){
 db.ref("students").once("value",s=>{
  s.forEach(x=>feeClassSelect.innerHTML+=`<option>${x.val().class}</option>`);
 });
}

function saveTotalFee(){
 if(!feeTermSelect.value || !totalFeeInput.value) return alert("Select Term and enter Fee");
 const term=feeTermSelect.value;
 const fee=Number(totalFeeInput.value);
 const cls=feeClassSelect.value || "all";
 db.ref(`finance/termFees/${term}/${cls}`).set({totalFee:fee},()=>{
  alert("Total fee set successfully!");
  totalFeeInput.value=""; feeTermSelect.value="";
  loadFeeSettings(); // refresh display
 });
}

function loadFeeSettings(){
 feeTable.innerHTML="<tr><td colspan='3'>No fee set yet</td></tr>";
 db.ref("finance/termFees").once("value",terms=>{
  if(!terms.exists()) return;
  let rows="";
  terms.forEach(termSnap=>{
   const term=termSnap.key;
   termSnap.forEach(clsSnap=>{
    const cls=clsSnap.key;
    const fee=clsSnap.val().totalFee;
    rows+=`<tr><td>${term}</td><td>${cls}</td><td>${fee}</td></tr>`;
   });
  });
  feeTable.innerHTML = rows || "<tr><td colspan='3'>No fee set yet</td></tr>";
 });
}

// GET TOTAL FEE FOR STUDENT & TERM
function getStudentTermFee(studentClass, term, callback){
 db.ref(`finance/termFees/${term}/${studentClass}`).once("value",s=>{
  if(s.exists()) return callback(s.val().totalFee);
  db.ref(`finance/termFees/${term}/all`).once("value",s2=>{
   if(s2.exists()) return callback(s2.val().totalFee);
   callback(50000); // default
  });
 });
}

// SAVE PAYMENT
function savePayment(){
 if(!studentSelect.value || !amountPaid.value || !termSelect.value)
  return alert("Fill all fields including Term");
 const [id,name,cls]=studentSelect.value.split("|");
 db.ref("finance/payments").push({
  studentId:id, studentName:name, class:cls,
  amount:Number(amountPaid.value), term:termSelect.value,
  date:paymentDate.value
 });
 amountPaid.value=""; termSelect.value="";
 loadStudentHistory();
 loadFinance();
}

// LOAD HISTORY
function loadStudentHistory(){
 if(!studentSelect.value) return;
 const [id,name,cls]=studentSelect.value.split("|");
 historyTable.innerHTML="";
 db.ref("finance/payments").orderByChild("studentId").equalTo(id)
 .once("value",s=>{
  if(!s.exists()){ historyTable.innerHTML="<tr><td colspan='5'>No payments</td></tr>"; return; }
  let cumulativePaidPerTerm={};
  s.forEach(p=>{
   const term=p.val().term;
   if(!cumulativePaidPerTerm[term]) cumulativePaidPerTerm[term]=0;
   cumulativePaidPerTerm[term]+=p.val().amount;
  });
  s.forEach(p=>{
   getStudentTermFee(cls, p.val().term, totalFee=>{
    const cumulativePaid=cumulativePaidPerTerm[p.val().term];
    const balance=totalFee-cumulativePaid;
    const delBtn=role==="admin"? `<button class="btn danger" onclick="reversePayment('${p.key}')">Delete</button>`:"";
    historyTable.innerHTML+=`
     <tr>
      <td>${p.val().date}</td>
      <td>${p.val().term}</td>
      <td>${p.val().amount}</td>
      <td>${balance}</td>
      <td>${delBtn}</td>
     </tr>`;
   });
  });
 });
}

// PRINT HISTORY
function printHistory(){
 if(!studentSelect.value) return alert("Select a student");
 const [id,name,cls]=studentSelect.value.split("|");
 historyStudent.innerHTML=`<strong>Student:</strong> ${name}<br><strong>Class:</strong> ${cls}<br><strong>Date:</strong> ${new Date().toLocaleDateString()}`;
 historyPrintTable.innerHTML = historyTable.innerHTML.replace(/<td>.*Delete.*<\/td>/g,'');
 document.getElementById("historyPrint").style.display="block";
 window.print();
 document.getElementById("historyPrint").style.display="none";
}

// REVERSE PAYMENT (ADMIN ONLY)
function reversePayment(id){
 if(role!=="admin") return;
 if(!confirm("Are you sure you want to reverse this payment?")) return;
 db.ref("finance/payments/"+id).remove(()=>{ loadStudentHistory(); loadFinance(); });
}

// LOAD BALANCES
function loadFinance(){
 db.ref("finance/payments").on("value",p=>{
  let t={};
  p.forEach(x=>t[x.val().studentId]=(t[x.val().studentId]||0)+x.val().amount);
  db.ref("students").once("value",s=>{
   financeTable.innerHTML="";
   s.forEach(x=>{
    const fee=50000, paid=t[x.key]||0;
    financeTable.innerHTML+=`
     <tr>
      <td>${x.val().name}</td>
      <td>${x.val().class}</td>
      <td>${fee}</td>
      <td>${paid}</td>
      <td>${fee-paid}</td>
     </tr>`;
   });
  });
 });
}

function goBack(){ location="index.html"; }
</script>

</body>
</html>
