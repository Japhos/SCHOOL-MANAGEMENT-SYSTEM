<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Finance Management - NYAMBUNWA ACADEMY</title>

<style>
body{
    font-family:'Segoe UI',Tahoma,sans-serif;
    margin:0;
    background:#e9f7ec;
}
header{
    background:#0b722d;
    color:#fff;
    padding:18px;
    text-align:center;
    font-size:26px;
    font-weight:700;
}
.sub-title{
    text-align:center;
    color:#064d1a;
    font-weight:600;
    margin-top:6px;
}
.container{ padding:20px; max-width:1100px; margin:0 auto; }
.section{
    background:#fff;
    padding:22px;
    border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    margin-top:20px;
    border-left:6px solid #0b722d;
}
h3{ color:#064d1a; margin-top:0; }
label{ display:block; margin-top:10px; font-weight:600; color:#064d1a; }
select, input{
    width:100%;
    padding:8px;
    margin-top:4px;
    border-radius:5px;
    border:1px solid #aaa;
}
.btn{
    margin-top:16px;
    padding:10px 18px;
    border:none;
    border-radius:6px;
    background:#0b722d;
    color:#fff;
    cursor:pointer;
}
table{
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}
th,td{
    border:1px solid #ccc;
    padding:8px;
    font-size:14px;
}
th{ background:#d6f5d9; }
footer{
    margin-top:40px;
    text-align:center;
    padding:12px;
    background:#0b722d;
    color:#fff;
}
@media print{
    body *{ visibility:hidden; }
    #receipt, #receipt *{ visibility:visible; }
    #receipt{ position:absolute; top:0; left:0; width:100%; }
}
</style>
</head>

<body>

<header>FINANCE MANAGEMENT</header>
<div class="sub-title">NYAMBUNWA ACADEMY</div>

<div class="container">

<!-- PAYMENT ENTRY -->
<div class="section">
<h3>Record Fee Payment</h3>

<label>Select Class</label>
<select id="classSelect" onchange="loadStudentsByClass()">
    <option value="">Select Class</option>
</select>

<label>Select Student</label>
<select id="studentSelect" onchange="loadStudentHistory()">
    <option value="">Select Student</option>
</select>

<label>Amount Paid</label>
<input type="number" id="amountPaid">

<label>Payment Date</label>
<input type="date" id="paymentDate" readonly>

<button class="btn" onclick="savePayment()">Save Payment</button>
</div>

<!-- PAYMENT HISTORY -->
<div class="section">
<h3>Payment History (Selected Student)</h3>
<table>
<thead>
<tr>
<th>Date</th>
<th>Amount</th>
</tr>
</thead>
<tbody id="historyTable">
<tr><td colspan="2">Select a student to view history</td></tr>
</tbody>
</table>
</div>

<!-- PAYMENTS & BALANCES -->
<div class="section">
<h3>Payments & Balances</h3>
<table>
<thead>
<tr>
<th>Student</th>
<th>Class</th>
<th>Total Fee</th>
<th>Total Paid</th>
<th>Balance</th>
<th>Receipt</th>
</tr>
</thead>
<tbody id="financeTable"></tbody>
</table>

<button class="btn" onclick="goBack()">⬅ Back to Main Menu</button>
</div>

</div>

<footer>© 2025 NYAMBUNWA ACADEMY — School Management System</footer>

<!-- RECEIPT -->
<div id="receipt" style="display:none;padding:20px;">
<h2 style="text-align:center;color:#0b722d;">NYAMBUNWA ACADEMY</h2>
<p id="rDetails"></p>
<hr>
<p><strong>Authorized Signature:</strong> _____________________</p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
 apiKey:"AIzaSyBZWRqW1a0qLyx76QZapberiE4Mio97OqI",
 authDomain:"school-management-system-24753.firebaseapp.com",
 projectId:"school-management-system-24753",
 storageBucket:"school-management-system-24753.firebasestorage.app",
 messagingSenderId:"98011038194",
 appId:"1:98011038194:web:b54b1b91e543127347ab6b"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// LOGIN CHECK & INIT
window.onload = ()=>{
 if(!localStorage.getItem("loggedInUser")) location="login.html";
 setToday();
 loadClasses();
 loadFinance();
};

// SET TODAY'S DATE
function setToday(){
 const today = new Date().toISOString().split("T")[0];
 paymentDate.value = today;
}

// LOAD CLASSES
function loadClasses(){
 let classes=new Set();
 db.ref("students").once("value",snap=>{
  snap.forEach(s=>classes.add(s.val().class));
  classes.forEach(c=>{
    classSelect.innerHTML+=`<option value="${c}">${c}</option>`;
  });
 });
}

// LOAD STUDENTS BY CLASS
function loadStudentsByClass(){
 studentSelect.innerHTML="<option value=''>Select Student</option>";
 historyTable.innerHTML="<tr><td colspan='2'>Select a student to view history</td></tr>";
 if(!classSelect.value) return;

 db.ref("students")
   .orderByChild("class")
   .equalTo(classSelect.value)
   .once("value",snap=>{
    snap.forEach(s=>{
      const v=s.val();
      studentSelect.innerHTML+=
       `<option value="${s.key}|${v.name}|${v.class}">
          ${v.name}
        </option>`;
    });
 });
}

// SAVE PAYMENT
function savePayment(){
 if(!studentSelect.value || !amountPaid.value)
   return alert("Fill all fields");

 const [id,name,cls]=studentSelect.value.split("|");

 db.ref("finance/payments").push({
  studentId:id,
  studentName:name,
  class:cls,
  amount:Number(amountPaid.value),
  date:paymentDate.value
 });

 amountPaid.value="";
 loadStudentHistory();
}

// LOAD PAYMENT HISTORY
function loadStudentHistory(){
 if(!studentSelect.value) return;

 const [id]=studentSelect.value.split("|");
 historyTable.innerHTML="";

 db.ref("finance/payments")
   .orderByChild("studentId")
   .equalTo(id)
   .once("value",snap=>{
    if(!snap.exists()){
      historyTable.innerHTML="<tr><td colspan='2'>No payments found</td></tr>";
      return;
    }
    snap.forEach(p=>{
      const v=p.val();
      historyTable.innerHTML+=`
      <tr>
        <td>${v.date}</td>
        <td>${v.amount}</td>
      </tr>`;
    });
 });
}

// LOAD BALANCES
function loadFinance(){
 db.ref("finance/payments").on("value",snap=>{
  let totals={};
  snap.forEach(p=>{
    const v=p.val();
    totals[v.studentId]=(totals[v.studentId]||0)+v.amount;
  });

  db.ref("students").once("value",stuSnap=>{
    financeTable.innerHTML="";
    stuSnap.forEach(s=>{
      const v=s.val();
      const paid=totals[s.key]||0;
      const fee=50000;
      const bal=fee-paid;

      financeTable.innerHTML+=`
      <tr>
        <td>${v.name}</td>
        <td>${v.class}</td>
        <td>${fee}</td>
        <td>${paid}</td>
        <td>${bal}</td>
        <td>
          <button onclick="printReceipt('${v.name}','${v.class}',${paid},${bal})">
            Print
          </button>
        </td>
      </tr>`;
    });
  });
 });
}

// PRINT RECEIPT
function printReceipt(name,cls,paid,bal){
 receipt.style.display="block";
 rDetails.innerHTML=`
 <strong>Student:</strong> ${name}<br>
 <strong>Class:</strong> ${cls}<br>
 <strong>Total Paid:</strong> ${paid}<br>
 <strong>Balance:</strong> ${bal}<br>
 <strong>Date:</strong> ${new Date().toLocaleDateString()}
 `;
 window.print();
 receipt.style.display="none";
}

function goBack(){ location="index.html"; }
</script>

</body>
</html>
