<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Examinations & Results - NYAMBUNWA ACADEMY</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- EXCEL (SheetJS) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBZWRqW1a0qLyx76QZapberiE4Mio97OqI",
    authDomain: "school-management-system-24753.firebaseapp.com",
    projectId: "school-management-system-24753",
    storageBucket: "school-management-system-24753.firebasestorage.app",
    messagingSenderId: "98011038194",
    appId: "1:98011038194:web:b54b1b91e543127347ab6b",
    measurementId: "G-7M9W1CBJD9"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<style>
body { margin:0; font-family:"Segoe UI",sans-serif; background:#e9f7ec; }
header { background:#0b722d; color:white; padding:16px; text-align:center; font-size:26px; font-weight:bold; }
.sub-title { text-align:center; font-size:18px; color:#064d1a; margin-top:4px; font-weight:600; }
.container { width:90%; margin:auto; margin-top:20px; }
.form-box { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); border-left:5px solid #0b722d; margin-bottom:20px;}
.form-box h3 { margin-top:0; color:#064d1a; }
input, select { width:100%; padding:10px; margin:6px 0 14px 0; border:1px solid #0b722d; border-radius:6px; font-size:15px; }
button { background:#0b722d; color:white; border:none; padding:12px 20px; font-size:16px; border-radius:6px; cursor:pointer; margin:5px; }
button:hover { background:#095a24; }
table { width:100%; border-collapse:collapse; margin-top:25px; background:white; border-radius:10px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
th, td { padding:12px; border-bottom:1px solid #c5e6cc; text-align:left; }
th { background:#0b722d; color:white; }
tr:nth-child(even) { background:#d7f5dd; }
tr:hover { background:#c3edc5; cursor:pointer; }
.back-btn { margin-top:30px; text-align:center; }
.back-btn a { text-decoration:none; background:#064d1a; color:white; padding:10px 20px; border-radius:6px; font-size:18px; }

/* SEARCH BOX */
.search-box { margin:20px 0; }
.search-box input { width:250px; padding:10px; border:1px solid #0b722d; border-radius:6px; font-size:15px; }
#generateReportBtn { margin-bottom:20px; }
.selected-row { background:#c3edc5 !important; }
</style>
</head>

<body>

<header>EXAMINATIONS & RESULTS</header>
<div class="sub-title">NYAMBUNWA ACADEMY</div>

<div class="container">

    <!-- -------------------- SEARCH & EXPORT BUTTONS -------------------- -->
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search by year, class, term, student, subject..." onkeyup="searchTable()">
        <button onclick="exportToExcel()">Export Excel</button>
        <button onclick="document.getElementById('excelFile').click()">Import Excel</button>
        <button onclick="window.print()">Print</button>
        <input type="file" id="excelFile" accept=".xlsx" style="display:none" onchange="importFromExcel(event)">
    </div>

    <div class="form-box">
        <h3>Add Exam Result</h3>
        <select id="examYear"></select>
        <select id="examTerm">
            <option value="">Select Term</option>
            <option value="Term 1">Term 1</option>
            <option value="Term 2">Term 2</option>
            <option value="Term 3">Term 3</option>
        </select>
        <select id="examClass" onchange="loadStudents()">
            <option value="">Select Class</option>
        </select>
        <select id="examStudent">
            <option value="">Select Student</option>
        </select>
        <select id="examSubject">
            <option value="">Select Subject</option>
        </select>
        <input type="number" id="examScore" placeholder="Score/Marks">
        <button onclick="addResult()">Add Result</button>
    </div>

    <button id="generateReportBtn">Generate Report for Selected Student</button>

    <table id="resultsTable">
        <thead>
            <tr>
                <th>Student</th>
                <th>Year</th>
                <th>Term</th>
                <th>Class</th>
                <th>Subjects</th>
                <th>Average</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="back-btn">
        <a href="index.html">‚Üê Back to Main Menu</a>
    </div>

</div>

<script>
// ============================
// LOGIN CHECK
// ============================
(function(){
    const loggedInUser = localStorage.getItem("loggedInUser");
    const userRole = localStorage.getItem("userRole");
    if(!loggedInUser || !userRole){
        alert("Please log in first!");
        window.location.href = "login.html";
    }
})();

// ==========================
// REMARKS FUNCTION
// ==========================
function getRemarks(score) {
    score = Number(score);
    if(score >= 80) return "Excellent";
    if(score >= 70) return "Very Good";
    if(score >= 60) return "Good";
    if(score >= 50) return "Fair";
    if(score >= 40) return "Poor";
    return "Fail";
}

// ==========================
// LOAD YEARS
// ==========================
function loadYears() {
    const yearSelect = document.getElementById("examYear");
    const now = new Date().getFullYear();
    yearSelect.innerHTML = `<option value="">Select Year</option>`;
    for (let y = 2020; y <= now; y++) yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
}

// ==========================
// LOAD CLASSES
// ==========================
function loadClasses() {
    const classSelect = document.getElementById("examClass");
    classSelect.innerHTML = `<option value="">Select Class</option>`;
    db.ref("classes").once("value", snap => {
        snap.forEach(cls => {
            classSelect.innerHTML += `<option value="${cls.val().name}">${cls.val().name}</option>`;
        });
    });
}

// ==========================
// LOAD STUDENTS & SUBJECTS
// ==========================
function loadStudents() {
    const className = document.getElementById("examClass").value;
    const studentSelect = document.getElementById("examStudent");
    const subjectSelect = document.getElementById("examSubject");
    studentSelect.innerHTML = `<option value="">Select Student</option>`;
    subjectSelect.innerHTML = `<option value="">Select Subject</option>`;
    if (!className) return;

    db.ref("students").orderByChild("class").equalTo(className).once("value", snap => {
        snap.forEach(student => {
            studentSelect.innerHTML += `<option value="${student.key}">${student.val().name}</option>`;
        });
    });

    db.ref("classes").orderByChild("name").equalTo(className).once("value", snap => {
        snap.forEach(cls => {
            const subjects = cls.val().subjects || [];
            subjects.forEach(sub => {
                subjectSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
            });
        });
    });
}

// ==========================
// ADD RESULT
// ==========================
function addResult() {
    const year = document.getElementById("examYear").value;
    const term = document.getElementById("examTerm").value;
    const cls = document.getElementById("examClass").value;
    const studentID = document.getElementById("examStudent").value;
    const subject = document.getElementById("examSubject").value;
    const score = document.getElementById("examScore").value.trim();
    if (!year || !term || !cls || !studentID || !subject || !score) return alert("Fill all fields");

    db.ref("students/" + studentID).once("value", snap => {
        const studentName = snap.val().name;
        db.ref("results").push({year, term, class: cls, studentID, studentName, subject, score}, err=>{
            if(!err){ document.getElementById("examScore").value=""; loadResults(); }
        });
    });
}

// ==========================
// EXPORT / IMPORT EXCEL
// ==========================
function exportToExcel() {
    const wb = XLSX.utils.book_new();
    const table = document.getElementById("resultsTable");
    const ws = XLSX.utils.table_to_sheet(table);
    XLSX.utils.book_append_sheet(wb, ws, "Results");
    XLSX.writeFile(wb, "Exam_Results.xlsx");
}
function importFromExcel(evt) {
    const file = evt.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type:'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet);
        rows.forEach(r=>{
            if(!r.Year||!r.Term||!r.Class||!r.Student||!r.Subject||!r.Score) return;
            db.ref("results").push({
                year:r.Year, term:r.Term, class:r.Class,
                studentName:r.Student, subject:r.Subject, score:r.Score
            });
        });
        alert("Import successful!");
        loadResults();
    };
    reader.readAsArrayBuffer(file);
}

// ==========================
// LOAD & DISPLAY RESULTS
// ==========================
let selectedStudentRow = null;

function selectTableRow(row){
    document.querySelectorAll("#resultsTable tbody tr").forEach(r=>r.classList.remove('selected-row'));
    row.classList.add('selected-row');
    selectedStudentRow = row;
}

function loadResults(){
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";
    db.ref("results").once("value", snap=>{
        const studentResults = {};
        snap.forEach(res=>{
            const r = res.val();
            if(!studentResults[r.studentID]) studentResults[r.studentID] = [];
            studentResults[r.studentID].push(r);
        });
        const sortedIDs = Object.keys(studentResults).sort((a,b)=>{
            const avgA = studentResults[a].reduce((sum,r)=>sum+Number(r.score),0)/studentResults[a].length;
            const avgB = studentResults[b].reduce((sum,r)=>sum+Number(r.score),0)/studentResults[b].length;
            return avgB - avgA;
        });
        sortedIDs.forEach(studentID=>{
            const results = studentResults[studentID];
            const studentName = results[0].studentName;
            const avg = results.reduce((sum,r)=>sum+Number(r.score),0)/results.length;
            const subjectsStr = results.map(r=>r.subject + ':' + r.score).join(', ');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${studentName}</td>
                <td>${results[0].year}</td>
                <td>${results[0].term}</td>
                <td>${results[0].class}</td>
                <td>${subjectsStr}</td>
                <td>${avg.toFixed(2)}</td>
                <td>${getRemarks(avg)}</td>
            `;
            row.onclick = ()=>selectTableRow(row);
            tbody.appendChild(row);
        });
    });
}

// ==========================
// GENERATE STUDENT REPORT
// ==========================
document.getElementById("generateReportBtn").onclick = function() {
    if(!selectedStudentRow) return alert("Select a student from the table first!");
    const cells = selectedStudentRow.children;
    const studentName = cells[0].innerText;
    const year = cells[1].innerText;
    const term = cells[2].innerText;
    const studentClass = cells[3].innerText;
    const subjects = cells[4].innerText.split(', ');
    const avg = Number(cells[5].innerText);
    const generalRemarks = cells[6].innerText;

    let printWindow = window.open('','height=800,width=800');
    let html = `
<html><head><title>Report - ${studentName}</title>
<style>
body{font-family:"Segoe UI",sans-serif;margin:40px;color:#064d1a;}
h2,h3,h4{text-align:center;margin:0;}
h2{color:#0b722d;}
table{width:100%;border-collapse:collapse;margin-top:20px;}
table, th, td{border:1px solid #0b722d;}
th, td{padding:12px;text-align:center;}
th{background:#0b722d;color:white;}
tr:nth-child(even){background:#d7f5dd;}
tr:nth-child(odd){background:#e6f9e8;}
.remarks{margin-top:20px;font-weight:bold;}
.signatures{margin-top:60px;display:flex;justify-content:space-between;}
.signatures div{text-align:center;}
</style>
</head><body>
<h2>NYAMBUNWA ACADEMY</h2>
<h3>P.O BOX 742-40200 KISII, KENYA</h3>
<h3>REPORT FORM</h3>
<h4>Student: ${studentName}</h4>
<h4>Class: ${studentClass}</h4>
<h4>Year: ${year} | Term: ${term}</h4>
<table><thead><tr><th>Subject</th><th>Score</th><th>Remarks</th></tr></thead><tbody>
${subjects.map(s=>{
    const [sub, score] = s.split(':');
    return `<tr><td>${sub}</td><td>${score}</td><td>${getRemarks(score)}</td></tr>`;
}).join('')}
</tbody></table>
<div class="remarks">Average Score: ${avg.toFixed(2)} | General Remarks: ${generalRemarks}</div>
<div class="signatures">
<div>___________________<br>Class Teacher</div>
<div>___________________<br>HeadTeacher</div>
</div>
</body></html>`;
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
};

// ==========================
// SEARCH TABLE
// ==========================
function searchTable() {
    const filter = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll("#resultsTable tbody tr").forEach(row=>{
        row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
}

// ==========================
// INIT
// ==========================
window.onload = function(){
    loadYears();
    loadClasses();
    loadStudents();
    loadResults();
};
</script>

</body>
</html>
