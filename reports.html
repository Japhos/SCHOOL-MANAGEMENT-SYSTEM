<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reports - NYAMBUNWA ACADEMY</title>

<!-- Firebase v8.10.0 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body {margin:0;font-family:"Segoe UI",sans-serif;background:#e9f7ec;}
header{background:#0b722d;color:white;padding:16px;text-align:center;font-size:26px;font-weight:bold;}
.sub-title{text-align:center;font-size:18px;color:#064d1a;margin-top:4px;font-weight:600;}
.container{width:90%;margin:auto;margin-top:20px;}
select,input{width:100%;padding:10px;margin:6px 0 14px 0;border:1px solid #0b722d;border-radius:6px;font-size:15px;}
button{background:#0b722d;color:white;border:none;padding:12px 20px;font-size:16px;border-radius:6px;cursor:pointer;margin:5px;}
button:hover{background:#095a24;}
.report{border:2px solid #0b722d;padding:20px;margin-top:20px;background:white;border-radius:10px;display:flex;flex-direction:column;justify-content:space-between;}
.report h2,h3{text-align:center;color:#064d1a;margin:4px 0;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #064d1a;padding:8px;text-align:left;}
th{background:#0b722d;color:white;}
.signature{display:flex;justify-content:space-between;margin-top:50px;}
.signature div{width:45%; text-align:center;}
.signature-line{border-top:1px solid #000; margin-top:40px;}
.print-btn{margin-top:10px;background:#0b722d;color:white;padding:10px 18px;border:none;border-radius:6px;cursor:pointer;}
.print-btn:hover{background:#064d1a;}

/* =================== PRINT =================== */
@media print {
    body { background:white; font-family:"Segoe UI",sans-serif; margin:0; padding:0; }
    #mainContent, button { display:none !important; }

    .report {
        width: 210mm; /* A4 width */
        min-height: 297mm; /* A4 height */
        margin: 0 auto;
        padding: 20mm;
        box-sizing: border-box;
        border: 8px solid #0b722d; /* beautiful green border */
        border-radius: 10px;
        page-break-after: always;
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* push signatures to bottom */
    }

    table { page-break-inside:auto; width:100%; }
    tr { page-break-inside:avoid; page-break-after:auto; }
    th, td { font-size:12pt; padding:6px; }

    .signature { margin-top:20px; display:flex; justify-content:space-between; }
    .signature-line { border-top:1px solid #000; margin-top:40px; }

    /* Optional: shrink table font if too many rows */
    .report table { font-size:11pt; }
}
</style>
</head>

<body>

<header>REPORTS MODULE</header>
<div class="sub-title">NYAMBUNWA ACADEMY</div>

<div class="container" id="mainContent">
    <h3>Generate Student Report Form</h3>

    <label for="reportClass">Select Class:</label>
    <select id="reportClass"></select>

    <label for="reportStudent">Select Student:</label>
    <select id="reportStudent"></select>

    <label for="reportYear">Select Year:</label>
    <select id="reportYear">
        <option value="">All Years</option>
    </select>

    <label for="reportTerm">Select Term:</label>
    <select id="reportTerm">
        <option value="">All Terms</option>
        <option value="Term 1">Term 1</option>
        <option value="Term 2">Term 2</option>
        <option value="Term 3">Term 3</option>
    </select>

    <button onclick="showReport()">Generate Report</button>
</div>

<div id="reportArea"></div>

<script>
var firebaseConfig = {
    apiKey: "AIzaSyBZWRqW1a0qLyx76QZapberiE4Mio97OqI",
    authDomain: "school-management-system-24753.firebaseapp.com",
    databaseURL: "https://school-management-system-24753-default-rtdb.firebaseio.com/",
    projectId: "school-management-system-24753",
    storageBucket: "school-management-system-24753.firebasestorage.app",
    messagingSenderId: "98011038194",
    appId: "1:98011038194:web:b54b1b91e543127347ab6b",
    measurementId: "G-7M9W1CBJD9"
};
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ============================
// Load Classes
// ============================
function loadReportClasses(){
    const classSelect = document.getElementById("reportClass");
    classSelect.innerHTML = '<option value="">Select Class</option>';
    db.ref('classes').once('value', snap=>{
        snap.forEach(c=>{
            const cls = c.val().name;
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            classSelect.appendChild(option);
        });
    });
}

// ============================
// Load Students
// ============================
function loadReportStudents(){
    const cls = document.getElementById("reportClass").value;
    const studentSelect = document.getElementById("reportStudent");
    studentSelect.innerHTML = '<option value="">Select Student</option>';
    if(!cls) return;
    db.ref('students').orderByChild('class').equalTo(cls).once('value', snap=>{
        snap.forEach(s=>{
            const option = document.createElement('option');
            option.value = s.key;
            option.textContent = s.val().name + ' (' + (s.val().adm || 'N/A') + ')';
            studentSelect.appendChild(option);
        });
    });
}

// ============================
// Load Years
// ============================
function loadYears(){
    const yearSelect = document.getElementById("reportYear");
    const currentYear = new Date().getFullYear();
    for(let y=2020; y<=currentYear; y++){
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
    }
}

// ============================
// Escape HTML
// ============================
function escapeHtml(text){ 
    return text.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
}

// ============================
// Show Report
// ============================
function showReport() {
    const cls = document.getElementById("reportClass").value;
    const studentKey = document.getElementById("reportStudent").value;
    const yearFilter = document.getElementById("reportYear").value;
    const termFilter = document.getElementById("reportTerm").value;

    if (!cls || !studentKey) { alert("Select class and student"); return; }

    db.ref('students/' + studentKey).once('value', s => {
        const student = s.val();

        db.ref('results').orderByChild('studentID').equalTo(studentKey).once('value', mSnap => {
            if (!mSnap.exists()) { alert('No marks for this student!'); return; }

            const marks = [];
            mSnap.forEach(ms => {
                const m = ms.val();
                if((!yearFilter || m.year == yearFilter) && (!termFilter || m.term == termFilter)){
                    marks.push(m);
                }
            });

            if(marks.length === 0){ alert('No marks found for selected filters!'); return; }

            function remark(mark) {
                mark = Number(mark);
                if(mark >= 80) return 'Excellent';
                if(mark >= 70) return 'Very Good';
                if(mark >= 60) return 'Good';
                if(mark >= 50) return 'Pass';
                return 'Fail';
            }

            const total = marks.reduce((sum,m)=>sum+Number(m.score),0);
            const avg = (total/marks.length).toFixed(2);

            let generalRemark = '';
            if(avg>=80) generalRemark='Excellent Performance';
            else if(avg>=70) generalRemark='Very Good Performance';
            else if(avg>=60) generalRemark='Good Performance';
            else if(avg>=50) generalRemark='Fair Performance';
            else generalRemark='Poor Performance';

            let rows = marks.map(m=>`<tr><td>${escapeHtml(m.subject)}</td><td>${escapeHtml(m.score)}</td><td>${escapeHtml(remark(m.score))}</td></tr>`).join('');

            const html = `<div class="report">
                <h2>NYAMBUNWA ACADEMY</h2>
                <h3>P.O BOX 742-40200, KISII, KENYA</h3>
                <p><strong>Student:</strong> ${escapeHtml(student.name)} | <strong>Reg No:</strong> ${escapeHtml(student.adm || 'N/A')} | <strong>Class:</strong> ${escapeHtml(student.class)}</p>
                <p><strong>Year:</strong> ${yearFilter || 'All'} | <strong>Term:</strong> ${termFilter || 'All'}</p>
                <table><tr><th>Subject</th><th>Marks</th><th>Remarks</th></tr>${rows}</table>
                <p><strong>Total:</strong> ${total}</p>
                <p><strong>Average:</strong> ${avg}</p>
                <p><strong>General Remark:</strong> ${generalRemark}</p>
                <div class="signature">
                    <div>Class Teacher<div class="signature-line"></div></div>
                    <div>Headteacher<div class="signature-line"></div></div>
                </div>
                <button onclick="backToMain()">‚Üê Back</button>
                <button onclick="window.print()">Print Report</button>
            </div>`;

            document.getElementById("mainContent").style.display = "none";
            document.getElementById("reportArea").innerHTML = html;
        });
    });
}

// ============================
// Back to Main
// ============================
function backToMain(){
    document.getElementById("reportArea").innerHTML='';
    document.getElementById("mainContent").style.display='block';
}

// ============================
// Event Listeners
// ============================
document.getElementById("reportClass").addEventListener('change', loadReportStudents);

// ============================
// INIT
// ============================
window.onload = function(){
    loadReportClasses();
    loadYears();
};
</script>

</body>
</html>
